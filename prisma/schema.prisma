generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Hospital {
  id        Int             @id @default(autoincrement())
  name      String
  address   String?
  createdAt DateTime?       @default(now()) @db.Timestamp(6)
  records   MedicalRecord[]
  doctors   User[]
}

model User {
  id                 Int             @id @default(autoincrement())
  name               String
  email              String          @unique
  password           String
  hospitalName       String?
  createdAt          DateTime        @default(now())
  hospitalId         Int?
  accessLogs         AccessLog[]
  medicalRecords     MedicalRecord[]
  registeredPatients Patient[]
  hospital           Hospital?       @relation(fields: [hospitalId], references: [id], onUpdate: NoAction)

  accessSessions AccessSession[] @relation("DoctorAccessSessions")
}

model Patient {
  id                    Int                   @id @default(autoincrement())
  name                  String
  biometricHash         String                @unique
  bloodGroup            String?
  height                Float?
  weight                Float?
  allergies             String?
  createdAt             DateTime              @default(now())
  dateOfBirth           DateTime?             @db.Timestamp(6)
  gender                String?
  phone                 String?
  email                 String?
  address               String?
  currentMedications    String?
  emergencyContactName  String?
  emergencyContactPhone String?
  registeredById        Int?
  accessLogs            AccessLog[]
  biometricCredentials  BiometricCredential[]
  biometricSessions     BiometricSession[]
  medicalRecords        MedicalRecord[]
  registeredBy          User?                 @relation(fields: [registeredById], references: [id], onDelete: Restrict, onUpdate: NoAction)
}

model MedicalRecord {
  id             Int                 @id @default(autoincrement())
  patientId      Int
  doctorId       Int
  diagnosis      String
  prescription   String
  notes          String?
  createdAt      DateTime            @default(now())
  hospitalId     Int
  visitType      String?
  chiefComplaint String?
  vitals         String?
  investigations String?
  followUpDate   DateTime?           @db.Timestamp(6)
  accessLogs     AccessLog[]
  attachments    MedicalAttachment[]
  doctor         User                @relation(fields: [doctorId], references: [id])
  hospital       Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  patient        Patient             @relation(fields: [patientId], references: [id])
}

model MedicalAttachment {
  id              Int           @id @default(autoincrement())
  fileName        String
  filePath        String
  fileType        String
  fileSize        Int
  uploadedAt      DateTime?     @default(now()) @db.Timestamp(6)
  medicalRecordId Int
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model AccessLog {
  id              Int            @id @default(autoincrement())
  patientId       Int
  userId          Int
  action          String
  createdAt       DateTime       @default(now())
  medicalRecordId Int?
  user            User           @relation(fields: [userId], references: [id], onDelete: SetNull, map: "AccessLog_doctorId_fkey")
  patient         Patient        @relation(fields: [patientId], references: [id])
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id], onUpdate: NoAction, map: "AccessLog_record_fkey")
}

model BiometricSession {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  patientId Int
  challenge String
  expiresAt DateTime  @db.Timestamp(6)
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  patient   Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model BiometricCredential {
  id           Int       @id @default(autoincrement())
  patientId    Int
  credentialId String    @unique
  publicKey    String
  counter      Int
  deviceName   String?
  createdAt    DateTime? @default(now()) @db.Timestamp(6)
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}


model AccessSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  doctorId  Int
  patientId Int?
  challenge String?
  status    String   @default("pending")
  expiresAt DateTime @db.Timestamp(6)
  createdAt DateTime @default(now()) @db.Timestamp(6)

  doctor    User     @relation("DoctorAccessSessions", fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([status])
}